- hosts: master
  vars:
      ansible_python_interpreter: /usr/bin/python3

  tasks:    
  
    - shell: helm repo add "{{repo_name}}" "{{repo_url}}"
    
    - local_action: copy content="{{ values }}" dest=/tmp/helm_values.yaml
    
    - copy:
        src: /tmp/helm_values.yaml
        dest: /tmp/helm_values.yaml
     
    - shell: helm uninstall "{{name}}"
      ignore_errors: yes
    
    
    - shell: helm install "{{name}}" "{{chart_name}}"  -f /tmp/helm_values.yaml
      register: helm_install_output
      
    - pause:
        seconds: 2
      
    - shell: kubectl get pod/"{{name}}" -o json
      register: kubectl_get_pods
      when: status is defined

    - debug:
        var: kubectl_get_pods.stdout|from_json|json_query('items[*]')
      when: status is defined
    
      
    - shell: kubectl get pod/"{{name}}" -o json
      register: kubectl_get_pods
      until: kubectl_get_pods.stdout|from_json|json_query('items[*].status.phase')|unique == ["{{status}}"]
      when: status is defined
  
  


      
